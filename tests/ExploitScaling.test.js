
// Mock Phaser globally BEFORE imports
global.Phaser = {
    Scene: class {
        constructor(config) { this.config = config; }
    },
    Utils: {
        Array: {
            GetRandom: (arr) => arr[0]
        }
    },
    Display: {
        Color: {
            Interpolate: {
                ColorWithColor: () => ({ r: 0, g: 0, b: 0 })
            }
        }
    }
};

const { MainScene } = require('../js/MainScene.js');
const { Nadagotchi } = require('../js/Nadagotchi.js');

describe('Exploit: Non-Scaling Work Rewards', () => {
    let mainScene;
    let nadagotchi;

    beforeEach(() => {
        mainScene = new MainScene();
        // Mock internal setup
        mainScene.add = {
            sprite: jest.fn().mockReturnValue({
                setScale: jest.fn().mockReturnThis(),
                setVisible: jest.fn().mockReturnThis(),
                setInteractive: jest.fn().mockReturnThis(),
                on: jest.fn().mockReturnThis(),
                setOrigin: jest.fn().mockReturnThis(),
                setPosition: jest.fn().mockReturnThis(),
            }),
            image: jest.fn().mockReturnValue({
                setOrigin: jest.fn().mockReturnThis(),
                setBlendMode: jest.fn().mockReturnThis(),
                setVisible: jest.fn().mockReturnThis(),
            }),
            graphics: jest.fn().mockReturnValue({
                clear: jest.fn(),
                fillStyle: jest.fn(),
                fillRect: jest.fn(),
            }),
            text: jest.fn().mockReturnValue({
                setOrigin: jest.fn().mockReturnThis(),
                setText: jest.fn().mockReturnThis(),
                setPosition: jest.fn().mockReturnThis(),
            }),
        };

        mainScene.textures = {
            get: jest.fn().mockReturnValue({
                getFrameNames: jest.fn().mockReturnValue([]),
                add: jest.fn()
            }),
            createCanvas: jest.fn().mockReturnValue({
                context: {
                    createLinearGradient: jest.fn().mockReturnValue({ addColorStop: jest.fn() }),
                    createRadialGradient: jest.fn().mockReturnValue({ addColorStop: jest.fn() }),
                    fillRect: jest.fn(),
                },
                clear: jest.fn(),
                refresh: jest.fn(),
                width: 800,
                height: 600,
                setSize: jest.fn(),
            })
        };

        mainScene.scale = {
            width: 800,
            height: 600,
            on: jest.fn()
        };

        mainScene.cameras = {
            main: {
                setSize: jest.fn(),
                setViewport: jest.fn(),
                width: 800,
                height: 600
            }
        };

        mainScene.time = {
            addEvent: jest.fn()
        };

        mainScene.game = {
            events: {
                emit: jest.fn(),
                on: jest.fn()
            }
        };

        mainScene.scene = {
            launch: jest.fn()
        };

        nadagotchi = new Nadagotchi('Adventurer');
        mainScene.nadagotchi = nadagotchi;
        nadagotchi.addJournalEntry = jest.fn();
        nadagotchi.handleAction = jest.fn();
    });

    test('Work rewards diminish based on skill level and happiness', () => {
        // Case 1: Low Skill (0)
        nadagotchi.skills.logic = 0;
        nadagotchi.stats.happiness = 0;

        mainScene.handleWorkResult({ success: true, career: 'Innovator' });

        // Skill gain: 1.5 * (20 / (20 + 0)) = 1.5
        expect(nadagotchi.skills.logic).toBeCloseTo(1.5, 3);
        // Happiness gain: 25 * (100 - 0)/100 = 25.
        expect(nadagotchi.stats.happiness).toBeCloseTo(25, 3);

        // Case 2: High Skill (50) and Mid Happiness (50)
        nadagotchi.skills.logic = 50;
        nadagotchi.stats.happiness = 50;

        mainScene.handleWorkResult({ success: true, career: 'Innovator' });

        // Skill gain: 1.5 * (20 / (20 + 50)) = 1.5 * (2/7) ~= 0.42857
        expect(nadagotchi.skills.logic).toBeCloseTo(50 + (1.5 * (20/70)), 3);

        // Happiness gain: 25 * (50/100) = 12.5. Min check 5.
        expect(nadagotchi.stats.happiness).toBeCloseTo(50 + 12.5, 3);

        // Case 3: Very High Happiness (95)
        nadagotchi.skills.logic = 0;
        nadagotchi.stats.happiness = 95;

        mainScene.handleWorkResult({ success: true, career: 'Innovator' });

        // Happiness gain: 25 * (5/100) = 1.25. Should use min 5.
        expect(nadagotchi.stats.happiness).toBe(100); // 95 + 5 = 100
    });
});
