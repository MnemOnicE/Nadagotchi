import { Nadagotchi } from '../js/Nadagotchi.js';
import { PersistenceManager } from '../js/PersistenceManager.js';
import { Config } from '../js/Config.js';
import { setupLocalStorageMock } from './helpers/mockLocalStorage.js';
import * as Encoding from '../js/utils/Encoding.js';

describe('Exploit: Trivial Save Scumming', () => {
    let persistence;

    beforeEach(() => {
        setupLocalStorageMock();
        persistence = new PersistenceManager();
        localStorage.clear();
        jest.clearAllMocks();

        // Mock requestIdleCallback
        global.requestIdleCallback = (cb) => setTimeout(cb, 0);
    });

    test('Data is obfuscated and tamper-proof', async () => {
        const petData = { name: 'TestPet', stats: { happiness: 100 }, uuid: '123' };
        await persistence.savePet(petData);

        // Allow async save
        await new Promise(r => setTimeout(r, 50));

        const raw = localStorage.getItem('nadagotchi_save');

        // 1. Not Plain JSON
        expect(raw).not.toContain('"name":"TestPet"');

        // 2. Base64 Encoded (Simple Obfuscation)
        const [encoded, hash] = raw.split('|');
        expect(encoded).toBeDefined();
        expect(hash).toBeDefined();

        // 3. Integrity Check
        // Try to tamper
        const decoded = JSON.parse(Encoding.fromBase64(encoded));
        decoded.stats.happiness = 9999;
        const tamperedEncoded = Encoding.toBase64(JSON.stringify(decoded));

        localStorage.setItem('nadagotchi_save', `${tamperedEncoded}|${hash}`);

        // Assert load fails
        const loadedData = await persistence.loadPet();
        expect(loadedData).toBeNull();
    });

    test('Loads valid data correctly', async () => {
         const petData = { name: 'TestPet', stats: { happiness: 100 }, uuid: '123' };
         await persistence.savePet(petData);
         await new Promise(r => setTimeout(r, 50));

         const loadedData = await persistence.loadPet();
         expect(loadedData).toEqual(petData);
    });

    test('Detects tampering', async () => {
         const petData = { name: 'TestPet', stats: { happiness: 100 }, uuid: '123' };
         await persistence.savePet(petData);
         await new Promise(r => setTimeout(r, 50));

         // Tamper with hash
         const raw = localStorage.getItem('nadagotchi_save');
         const [encoded, hash] = raw.split('|');
         localStorage.setItem('nadagotchi_save', `${encoded}|FAKEHASH`);

         const loadedData = await persistence.loadPet();
         expect(loadedData).toBeNull();
    });
});
