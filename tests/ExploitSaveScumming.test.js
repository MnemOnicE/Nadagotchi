
import { PersistenceManager } from '../js/PersistenceManager.js';

// Mock localStorage
class LocalStorageMock {
    constructor() { this.store = {}; }
    clear() { this.store = {}; }
    getItem(key) { return this.store[key] || null; }
    setItem(key, value) { this.store[key] = String(value); }
    removeItem(key) { delete this.store[key]; }
}

const mockLocalStorage = new LocalStorageMock();
global.localStorage = mockLocalStorage;

// Mock btoa/atob if not present (Node environment)
if (typeof btoa === 'undefined') {
    global.btoa = (str) => Buffer.from(str, 'binary').toString('base64');
    global.atob = (str) => Buffer.from(str, 'base64').toString('binary');
}

describe('Exploit: Trivial Save Scumming', () => {
    let persistence;

    beforeEach(() => {
        persistence = new PersistenceManager();
        mockLocalStorage.clear();
    });

    test('Data is obfuscated and tamper-proof', async () => {
        const petData = { name: "TestPet", stats: { happiness: 100 } };
        persistence.savePet(petData);

        await new Promise(r => setTimeout(r, 300));

        const savedData = global.localStorage.getItem("nadagotchi_save");

        // Assert that the saved data is NOT plain JSON
        expect(savedData).not.toBe(JSON.stringify(petData));
        expect(savedData.startsWith('{')).toBe(false);

        // Assert that we can load it back correctly
        const loadedData = persistence.loadPet();
        expect(loadedData).toEqual(petData);
    });

    test('Detects tampering', async () => {
        const petData = { name: "TestPet", stats: { happiness: 100 } };
        persistence.savePet(petData);

        await new Promise(r => setTimeout(r, 300));

        let savedData = global.localStorage.getItem("nadagotchi_save");

        // Tamper with the data (assuming it's Base64 or similar)
        // We'll just append something or change a char
        const tamperedData = savedData.substring(0, savedData.length - 1) + 'A';
        global.localStorage.setItem("nadagotchi_save", tamperedData);

        // Attempt to load
        // Should return null or throw error, depending on implementation.
        // Let's assume it returns null or handles gracefully.
        const loadedData = persistence.loadPet();
        expect(loadedData).toBeNull();
    });
});
