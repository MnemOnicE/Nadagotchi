// tests/ExploitQuestBypass.test.js

jest.mock('../js/PersistenceManager');
const { Nadagotchi } = require('../js/Nadagotchi');
const { PersistenceManager } = require('../js/PersistenceManager');

// Helper to check if journal contains partial text
const journalContains = (journal, text) => {
    return journal.some(entry => entry.text.includes(text));
};

describe('Exploit: Quest Logic Bypass (Artisan)', () => {
    let pet;

    beforeEach(() => {
        PersistenceManager.mockImplementation(() => ({
            loadJournal: jest.fn().mockReturnValue([]),
            saveJournal: jest.fn(),
            loadRecipes: jest.fn().mockReturnValue([]),
            saveRecipes: jest.fn(),
            loadPet: jest.fn().mockReturnValue(null),
            savePet: jest.fn(),
            loadAchievements: jest.fn().mockReturnValue({ unlocked: [], progress: {} })
        }));

        pet = new Nadagotchi('Recluse');
        // Setup state: Quest started, Stage 2 (Needs to craft chair)
        pet.relationships = { 'Master Artisan': { level: 6 } };
        pet.quests = {
            'masterwork_crafting': { stage: 2, hasCraftedChair: false }
        };
        // Player has the recipe
        pet.discoveredRecipes = ['Masterwork Chair'];
    });

    test('Quest CANNOT be bypassed by cheating item into inventory', () => {
        // EXPLOIT ATTEMPT:
        // The player uses a console command or save edit to give themselves a 'Masterwork Chair'
        // WITHOUT actually crafting it (which sets the 'hasCraftedChair' flag).
        pet.inventory['Masterwork Chair'] = 1;

        // Verify precondition: flag is false
        expect(pet.quests['masterwork_crafting'].hasCraftedChair).toBe(false);

        // Act: Talk to Artisan
        const result = pet.interact('Master Artisan');

        // Verify UI does NOT offer completion
        // The text should be the description, NOT followed by "(Requirements Met!)"
        expect(result.text).not.toContain("(Requirements Met!)");

        // Ensure no action allows completion
        const completeOption = result.options.find(o => o.label === "Complete Stage");
        expect(completeOption).toBeUndefined();

        // Expect FAILURE (Stage should still be 2)
        expect(pet.quests['masterwork_crafting'].stage).toBe(2);
    });

    test('Quest can be completed by legitimately crafting', () => {
        // LEGITIMATE PLAY:
        // Inject recipe for test stability
        pet.recipes = {
            'Masterwork Chair': {
                description: 'A fine chair',
                materials: { 'Sticks': 10 }
            }
        };

        pet.inventory['Sticks'] = 10;

        // Act: Craft
        pet.craftItem('Masterwork Chair');

        // Check flag
        expect(pet.quests['masterwork_crafting'].hasCraftedChair).toBe(true);
        expect(pet.inventory['Masterwork Chair']).toBe(1);

        // Act: Talk to Artisan
        const result = pet.interact('Master Artisan');

        // Verify UI offers completion
        expect(result.text).toContain("(Requirements Met!)");

        const completeOption = result.options.find(o => o.label === "Complete Stage");
        expect(completeOption).toBeDefined();

        // Trigger the completion action
        completeOption.action();

        // Expect SUCCESS (Stage 3)
        expect(pet.quests['masterwork_crafting'].stage).toBe(3);
        expect(journalContains(pet.journal, "impressed by my chair")).toBe(true);
    });
});
