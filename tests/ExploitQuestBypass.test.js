
import { Nadagotchi } from '../js/Nadagotchi.js';

// Mock localStorage
class LocalStorageMock {
    constructor() { this.store = {}; }
    clear() { this.store = {}; }
    getItem(key) { return this.store[key] || null; }
    setItem(key, value) { this.store[key] = String(value); }
    removeItem(key) { delete this.store[key]; }
}
global.localStorage = new LocalStorageMock();

// Mock Phaser
global.Phaser = {
    Utils: {
        Array: {
            GetRandom: (arr) => arr[0]
        }
    }
};

describe('Exploit: Quest Logic Bypass (Artisan)', () => {
    let pet;

    beforeEach(() => {
        global.localStorage.clear();
        pet = new Nadagotchi('Recluse');
        // Manually set relationship to unlock quest
        pet.relationships['Master Artisan'] = { level: 5 };
        // Clear inventory
        pet.inventory = {};
    });

    test('Quest CANNOT be bypassed by cheating item into inventory', () => {
        // Start Quest
        pet.interact('Master Artisan');

        // Advance to Stage 2 (Give Sticks)
        pet.inventory['Sticks'] = 5;
        pet.interact('Master Artisan');
        expect(pet.quests['masterwork_crafting'].stage).toBe(2);

        // Stage 2: Wants Masterwork Chair
        // Cheat: Add chair directly to inventory
        pet.inventory['Masterwork Chair'] = 1;

        // Interact again
        pet.interact('Master Artisan');

        // Expect FAILURE (Stage should still be 2)
        expect(pet.quests['masterwork_crafting'].stage).toBe(2);
        expect(pet.journal[pet.journal.length - 1].text).toContain("I need to craft a Masterwork Chair");
    });

    test('Quest can be completed by legitimately crafting', () => {
        // Start Quest
        pet.interact('Master Artisan');

        // Advance to Stage 2
        pet.inventory['Sticks'] = 5;
        pet.interact('Master Artisan');
        expect(pet.quests['masterwork_crafting'].stage).toBe(2);

        // Setup materials for crafting
        // Masterwork Chair needs: Sticks: 10, Shiny Stone: 2
        pet.inventory['Sticks'] = 10;
        pet.inventory['Shiny Stone'] = 2;

        // Legitimately craft
        pet.craftItem('Masterwork Chair');

        // Interact again
        pet.interact('Master Artisan');

        // Expect SUCCESS (Stage 3)
        expect(pet.quests['masterwork_crafting'].stage).toBe(3);
    });
});
