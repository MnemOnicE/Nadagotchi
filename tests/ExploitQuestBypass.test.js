// tests/ExploitQuestBypass.test.js

jest.mock('../js/PersistenceManager');
const { Nadagotchi } = require('../js/Nadagotchi');
const { PersistenceManager } = require('../js/PersistenceManager');

// Helper to check if journal contains partial text
const journalContains = (journal, text) => {
    return journal.some(entry => entry.text.includes(text));
};

describe('Exploit: Quest Logic Bypass (Artisan)', () => {
    let pet;

    beforeEach(() => {
        PersistenceManager.mockImplementation(() => ({
            loadJournal: jest.fn().mockReturnValue([]),
            saveJournal: jest.fn(),
            loadRecipes: jest.fn().mockReturnValue([]),
            saveRecipes: jest.fn(),
            loadPet: jest.fn().mockReturnValue(null),
            savePet: jest.fn()
        }));

        pet = new Nadagotchi('Recluse');
        // Setup state: Quest started, Stage 2 (Needs to craft chair)
        pet.relationships = { 'Master Artisan': { level: 6 } };
        pet.quests = {
            'masterwork_crafting': { stage: 2, hasCraftedChair: false }
        };
        // Player has the recipe
        pet.discoveredRecipes = ['Masterwork Chair'];
        // Define recipe locally since ItemData is not mocked here (or relies on import)
        // Nadagotchi imports Recipes from ItemData. If we want to test crafting, we rely on Nadagotchi's internal recipe list
        // Assuming Nadagotchi uses the imported Recipes object.
    });

    test('Quest CANNOT be bypassed by cheating item into inventory', () => {
        // EXPLOIT ATTEMPT:
        // The player uses a console command or save edit to give themselves a 'Masterwork Chair'
        // WITHOUT actually crafting it (which sets the 'hasCraftedChair' flag).
        pet.inventory['Masterwork Chair'] = 1;

        // Verify precondition: flag is false
        expect(pet.quests['masterwork_crafting'].hasCraftedChair).toBe(false);

        // Act: Talk to Artisan
        pet.interact('Master Artisan');

        // Expect FAILURE (Stage should still be 2)
        expect(pet.quests['masterwork_crafting'].stage).toBe(2);
        expect(journalContains(pet.journal, "I need to craft a Masterwork Chair")).toBe(true);
    });

    test('Quest can be completed by legitimately crafting', () => {
        // LEGITIMATE PLAY:
        // Player has materials
        pet.inventory['Wood'] = 10; // Assuming wood/cloth for chair. Wait, check Nadagotchi.js or ItemData.js for recipe.
        // Actually, let's just check the code path for crafting setting the flag.
        // We need to know the recipe. From memory or code, Masterwork Chair needs materials.
        // Let's assume the mock pet has the recipe definition loaded (it imports ItemData).
        // To be safe, let's manually inject the recipe into the pet instance for this test to be robust against data changes.
        pet.recipes = {
            'Masterwork Chair': {
                description: 'A fine chair',
                materials: { 'Sticks': 10 } // Simplified
            }
        };

        pet.inventory['Sticks'] = 10;

        // Act: Craft
        pet.craftItem('Masterwork Chair');

        // Check flag
        expect(pet.quests['masterwork_crafting'].hasCraftedChair).toBe(true);
        expect(pet.inventory['Masterwork Chair']).toBe(1);

        // Act: Talk to Artisan
        pet.interact('Master Artisan');

        // Expect SUCCESS (Stage 3)
        expect(pet.quests['masterwork_crafting'].stage).toBe(3);
        expect(journalContains(pet.journal, "impressed by my chair")).toBe(true);
    });
});
