import { Nadagotchi } from '../js/Nadagotchi';

// Mock localStorage and Phaser
class LocalStorageMock {
    constructor() { this.store = {}; }
    clear() { this.store = {}; }
    getItem(key) { return this.store[key] || null; }
    setItem(key, value) { this.store[key] = String(value); }
    removeItem(key) { delete this.store[key]; }
}
global.localStorage = new LocalStorageMock();

const Phaser = {
    Utils: {
        Array: {
            GetRandom: (arr) => arr[0]
        }
    }
};
global.Phaser = Phaser;

describe('Exploit: Artisan Quest Bypass', () => {
    let pet;

    beforeEach(() => {
        pet = new Nadagotchi('Recluse'); // Artisan path friendly
    });

    test('Quest should NOT advance if item is found but not crafted', () => {
        // Setup: Quest Stage 2 (Needs to craft chair)
        pet.quests['masterwork_crafting'] = { stage: 2, name: 'Masterwork Crafting' };

        // Cheat: Add Masterwork Chair directly to inventory
        pet.inventory['Masterwork Chair'] = 1;

        // Ensure flag is NOT set (simulating finding/buying instead of crafting)
        // pet.quests['masterwork_crafting'].hasCraftedChair is undefined/false

        // Action: Interact with Artisan
        pet.relationships['Master Artisan'] = { level: 10 };
        pet._handleArtisanQuest();

        // Assertion: Should still be at stage 2
        expect(pet.quests['masterwork_crafting'].stage).toBe(2);

        // Assertion: Item should still be in inventory (wasn't consumed for quest)
        expect(pet.inventory['Masterwork Chair']).toBe(1);
    });

    test('Quest SHOULD advance if item is crafted legitimately', () => {
        // Setup: Quest Stage 2
        pet.quests['masterwork_crafting'] = { stage: 2, name: 'Masterwork Crafting' };

        // Setup: Materials for crafting
        pet.inventory['Sticks'] = 20;
        pet.inventory['Shiny Stone'] = 5;
        pet.discoveredRecipes.push("Masterwork Chair");

        // Action: Craft the item
        pet.craftItem('Masterwork Chair');

        // Assertion: Flag should be set
        expect(pet.quests['masterwork_crafting'].hasCraftedChair).toBe(true);
        expect(pet.inventory['Masterwork Chair']).toBe(1);

        // Action: Interact with Artisan
        pet.relationships['Master Artisan'] = { level: 10 };
        pet._handleArtisanQuest();

        // Assertion: Should advance to stage 3
        expect(pet.quests['masterwork_crafting'].stage).toBe(3);
        // Item consumed
        expect(pet.inventory['Masterwork Chair']).toBeUndefined();
    });
});
